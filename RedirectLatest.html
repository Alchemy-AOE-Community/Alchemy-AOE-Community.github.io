<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Redirecting to Latest Files…</title>
  <style>
    body { font: 1rem sans-serif; padding: 1rem; }
    #status { margin-bottom: 1em; color: #333; }
    a { display: block; margin: .25em 0; }
  </style>
</head>
<body>
  <p id="status">Initializing…</p>
  <div id="links"></div>

  <script>
  (async () => {
    const status = document.getElementById('status');
    const links  = document.getElementById('links');
    const prefix = new URLSearchParams(location.search).get('file');
    if (!prefix) {
      status.textContent = 'Error: no “?file=” parameter provided';
      return;
    }

    const owner  = 'Alchemy-AOE-Community';
    const repo   = 'CHEM-Published-Specifications';
    const branch = 'download-to-click-links';
    const folder = encodeURIComponent(prefix);
    const apiUrl = `https://api.github.com/repos/${owner}/${repo}`
                 + `/contents/${folder}?ref=${branch}`;

    let dir;
    try {
      const res = await fetch(apiUrl);
      if (!res.ok) throw new Error(res.statusText);
      dir = await res.json();
    } catch (err) {
      status.textContent = `Error fetching “${prefix}”: ${err.message}`;
      return;
    }

    // 1) Filter all files starting with the prefix
    const files = dir.filter(item =>
      item.type === 'file'
      && item.name.startsWith(prefix)
      && item.name.includes('.')
    );

    if (!files.length) {
      status.textContent = `No files found for “${prefix}”`;
      return;
    }

    // 2) Group by extension
    const latestByExt = files.reduce((acc, { name }) => {
      const ext = name.slice(name.lastIndexOf('.') + 1).toLowerCase();
      acc[ext] = acc[ext] || [];
      acc[ext].push(name);
      return acc;
    }, {});

    // 3) Sort groups, pick latest, build URLs & links
    const urls = {};
    Object.entries(latestByExt).forEach(([ext, names]) => {
      names.sort();
      const latest = names.pop();
      const rawUrl = `https://raw.githubusercontent.com/${owner}`
                   + `/${repo}/${branch}/${folder}/${encodeURIComponent(latest)}`;
      urls[ext] = { latest, rawUrl };

      const a = document.createElement('a');
      a.href       = rawUrl;
      a.target     = '_blank';
      a.textContent= `Latest .${ext}: ${latest}`;
      links.appendChild(a);
    });

    const exts = Object.keys(urls);
    status.textContent = `Found ${exts.length} file type${exts.length>1?'s':''}.`;

    // 4) Redirect priority: PDF first, else only ext
    let targetExt = exts.includes('pdf') ? 'pdf' : exts[0];
    if (targetExt) {
      // show links briefly, then navigate
      setTimeout(() => {
        status.textContent = `Redirecting to latest .${targetExt}…`;
        window.location.href = urls[targetExt].rawUrl;
      }, 200);
    }
  })();
  </script>
</body>
</html>